---
title: "Model fits"
output: html_document
---

```{r setup, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

```{r functions, cache=FALSE}
source("zoib-functions.R")
```

```{r mainfit, cache=TRUE, dependson="functions",warning=FALSE,message=FALSE}
library(rstan)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
sm <- stan_model("zoib1re.stan")

d <- get_dat(Firemort.BA.p, RdNBR, 
  file = "ALL_SHOBS_2010_2014_PLOTS_MASTER_w_CO_FINAL_20171029.csv",
  max_predictor = 2500)
m <- fit_model(d, model = sm, predictors = "xscaled")
print(m$model, probs = c(0.05, 0.5, 0.95), pars = "log_lik", include = FALSE)
p <- make_predictions(d = d, f = m$f, model = m$model)
g <- make_pred_plot(p, d)
print(g)

predictions <- make_predictions_dat(model = m$model, f = m$f, d = d)
make_roc(d = d, predictions = predictions)

library(loo)
extract_log_lik(m$model) %>% loo()
```

```{r residuals1, warning=FALSE}
mutate(d, pred = predictions, resid = pred - y) %>% 
  select(-y, -group, -xscaled, -yp, -y1, -y0) %>% 
  reshape2::melt(id.vars = "resid") %>%
  ggplot(aes(value, resid)) + 
  geom_point(alpha = 0.6) +
  facet_wrap(~variable, scales = "free_x") +
  ggsidekick::theme_sleek() +
  geom_hline(yintercept = 0, lty = 2, col = "blue")
```

# Interactions

```{r interactions, cache=TRUE, dependson="functions", warning=FALSE,message=FALSE}
sm <- stan_model("zoib1re.stan")
d <- mutate(d, ba_ha = arm::rescale(ba_ha),
  northing = arm::rescale(northing),
  easting = arm::rescale(easting),
  elev = arm::rescale(elev),
  heatload = arm::rescale(heatload),
  slope = arm::rescale(slope),
  aspect = arm::rescale(aspect)
)
m <- fit_model(d, model = sm,
  predictors = c("xscaled", "northing*xscaled", "elev*xscaled", 
    "easting*xscaled", "slope*xscaled", "heatload*xscaled", 
    "aspect*xscaled"))
extract_log_lik(m$model) %>% loo()
```

```{r}
predictions <- make_predictions_dat(model = m$model, f = m$f, d = d)
make_roc(d = d, predictions = predictions)
```

```{r residuals2, warning=FALSE}
mutate(d, pred = predictions, resid = pred - y) %>% 
  select(-y, -group, -xscaled, -yp, -y1, -y0) %>% 
  reshape2::melt(id.vars = "resid") %>%
  ggplot(aes(value, resid)) + 
  geom_point(alpha = 0.6) +
  facet_wrap(~variable, scales = "free_x") +
  ggsidekick::theme_sleek() +
  geom_hline(yintercept = 0, lty = 2, col = "blue")
```

```{r plot-interactions, cache=TRUE, dependson=c("interactions", "functions"), fig.height=6.5}
terms <- tibble(
  name = colnames(m$stan_dat$Xp_ij),
  num = as.character(seq_along(colnames(m$stan_dat$Xp_ij)))
)

models <- tibble(model = c("0", "1", "p"), 
  model_full = c("Pr(not 0)", "Pr(1)", "Proportion"))

b <- broom::tidyMCMC(m$model, estimate.method = "median", conf.int = TRUE,
  conf.method = "HPDinterval") %>% 
  filter(grepl("b[01p]+_j", term)) %>% 
  filter(!grepl("\\[1\\]", term)) %>% 
  # filter(!grepl("\\[2\\]", term)) %>% 
  mutate(num = gsub("b[01p]+_j\\[([0-9]+)\\]", "\\1", term)) %>% 
  mutate(model = gsub("b([01p]+)_j\\[([0-9]+)\\]", "\\1", term)) %>% 
  left_join(terms, by = "num") %>% 
  mutate(name = gsub("xscaled", " RdNBR", name))

b %>% 
  mutate(estimate = ifelse(model == 0, -estimate, estimate)) %>% 
  mutate(conf.low = ifelse(model == 0, -conf.low, conf.low)) %>% 
  mutate(conf.high = ifelse(model == 0, -conf.high, conf.high)) %>% 
  mutate(interaction = grepl(":", name)) %>% 
  inner_join(models, by = "model") %>% 
  ggplot(aes(y = estimate, x = (fct_relevel(name, " RdNBR", after = Inf)), 
    colour = model_full, shape = interaction)) +
  geom_hline(yintercept = 0, lty = 2, col = "grey55") +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high),
    position = position_dodge(width = 0.4)) +
  xlab("") + 
  ggsidekick::theme_sleek() +
  coord_flip() +
  scale_colour_brewer(palette = "Dark2") +
  scale_shape_manual(values = c(19, 21)) +
  labs(colour = "Model", shape = "Interaction", y = "Coefficient value")
```

# All

```{r}

d <- get_dat(Firemort.BA.p, RdNBR, 
  file = "ALL_SHOBS_2010_2014_PLOTS_MASTER_w_CO_FINAL_20171029.csv",
  max_predictor = 2500)
m <- fit_model(d, model = sm, predictors = "xscaled")
print(m$model, probs = c(0.05, 0.5, 0.95), pars = "log_lik", include = FALSE)
p <- make_predictions(d = d, f = m$f, model = m$model)
g <- make_pred_plot(p, d)
```

