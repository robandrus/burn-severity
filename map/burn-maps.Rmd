---
title: "burn-maps"
author: "Sean Anderson"
date: '2018-06-20'
output: html_document
---

```{r setup, knitr-opts, echo=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = TRUE,
  message = TRUE,
  comment = "#>",
  fig.path = "knitr-figs/",
  cache.path = "knitr-cache/",
  fig.asp = 0.618,
  echo = TRUE,
  autodep = TRUE,
  cache = TRUE,
  cache.comments = FALSE
)
```

```{r process}
# see RedRock_FireSeverity_prediction_v2.R
# # importing RdNBR
# RdNBR <- raster::raster("RedRockFire_Indices/RR_RdNBR.tif")
# # importing shapefile for fire perimeter
# perim <- rgdal::readOGR(dsn = "RedRockFire_Indices", layer = "RR_firePerimeter")
# 
# # masking to fire perimeter
# RdNBR.m <- raster::mask(RdNBR, perim)
# raster::plot(RdNBR.m)
# 
# # creating a point file
# RdNBR.pt <- raster::rasterToPoints(RdNBR.m, spatial = TRUE)
# raster::plot(RdNBR.pt)
# 
# # Reproject to RasterLayer's CRS - not necessary in this case b/c data all in
# # same projection
# # RdNBR.pt2 <- spTransform(RdNBR.pt, CRS(projection(RdNBR.m)))
# 
# # creating dataframe with values from RdNBR.pt
# data <- data.frame(
#   sp::coordinates(RdNBR.pt),
#   raster::extract(RdNBR.m, RdNBR.pt, method = "bilinear")
# )
# colnames(data) <- c("x", "y", "RdNBR_BL")
# 
# readr::write_rds(data, "RedRocks_coords_RdNBR_BL.rds")
```

```{r check}
# ggplot(filter(data, RdNBR_BL < 2500), aes(x, y, fill = RdNBR_BL)) + geom_raster()
```

```{r fit, results='hide'}
# data <- readr::read_rds("RedRocks_coords_RdNBR_BL.rds")
data <- readr::read_csv("RedRocks_data_Fig6.csv")
library(dplyr)
library(rstan)
library(readr)
options(mc.cores = parallel::detectCores())
source("../zoib-functions.R")
rstan_options(auto_write = TRUE)
sm <- rstan::stan_model("../zoib1re.stan")
file <- file.path("..", "data", "RockiesBurnSev_clean_20180216.csv")

x_vars <- c(
  "RdNBR_BL"
)
y_vars <- c(
  "CHARCOV",
  "Firemort.BA.p")
vars <- expand.grid(x = x_vars, y = y_vars, stringsAsFactors = FALSE)
out <- plyr::mlply(.data = vars, function(x, y) {
  d <- get_dat(!!quo_name(y), !!quo_name(x),
    file = file, max_predictor = 2500)
  m <- fit_model(d, model = sm, predictors = "xscaled", iter = 100L,
    chains = 1L)
  list(m = m, d = d, x = x, y = y)
})
```

```{r extract}
xx <- purrr::map_df(out, function(x) {
  pred_dat <- data

  pred_dat <- pred_dat[pred_dat$RdNBR_BL < max(x$d$x)*1, , drop = FALSE]
  pred_dat <- pred_dat[pred_dat$RdNBR_BL > min(x$d$x)*1, , drop = FALSE]
  pred_dat$xscaled <- (pred_dat$RdNBR_BL - x$d$xraw_mean[[1]]) / (2 * x$d$xraw_sd[[1]])
  e <- rstan::extract(x$m$model)
  
  mm_pred <- cbind(rep(1, nrow(pred_dat)), pred_dat$xscaled)
  re_id <- x$d[x$d$group == "rr", "group_id", drop = TRUE][[1]]
  # pred_p <- plogis(mm_pred %*% t(e$bp_j) +
  #     rep(e$zp_g[,re_id,drop=TRUE], each = nrow(mm_pred)))
  mu_inv_logit <- plogis(mm_pred %*% t(e$bp_j) +
    rep(e$zp_g[,re_id,drop=TRUE], each = nrow(mm_pred)))
  phi <- e$phi
  nmcmc <- ncol(mu_inv_logit)
  # add obs. error:
  pred_p <- t(apply(mu_inv_logit, 1, function(.x) {
    rbeta(n = nmcmc,
    shape1 = .x * phi,
    shape2 = (1 - .x) * phi)
  }))
  pred_0 <- plogis(mm_pred %*% t(e$b0_j) +
      rep(e$z0_g[,re_id,drop=TRUE], each = nrow(mm_pred)))
  pred_1 <- plogis(mm_pred %*% t(e$b1_j) +
      rep(e$z1_g[,re_id,drop=TRUE], each = nrow(mm_pred)))
  
  # pred_p <- plogis(mm_pred %*% t(e$bp_j))
  # pred_0 <- plogis(mm_pred %*% t(e$b0_j))
  # pred_1 <- plogis(mm_pred %*% t(e$b1_j))

  y_pred <- (1 - pred_0) * (pred_1 + (1 - pred_1) * pred_p)

  pred_df <- data.frame(
    pp_est = apply(pred_p, 1, quantile, probs = 0.5),
    p0_est = apply(pred_0, 1, quantile, probs = 0.5),
    p1_est = apply(pred_1, 1, quantile, probs = 0.5),
    q0.05 = apply(y_pred, 1, quantile, probs = 0.05),
    q0.50 = apply(y_pred, 1, quantile, probs = 0.5),
    q0.95 = apply(y_pred, 1, quantile, probs = 0.95),
    sd     = apply(y_pred, 1, sd),
    mean   = apply(y_pred, 1, mean)
  )
  pred_df <- mutate(pred_df, ci_width_90 = q0.95 - q0.05)

  stopifnot(nrow(pred_df) == nrow(pred_dat))
  pred_df$x <- pred_dat$x
  pred_df$y <- pred_dat$y
  pred_df$RdNBR_BL <- pred_dat$RdNBR_BL
  pred_df$response <- x$y
  pred_df$predictor <- x$x
  pred_df
})
readr::write_rds(xx, "RedRocks_predictions.rds")
```

```{r plot, fig.cap="The predictor"}
library(ggplot2)
library(scales)

x_ <- -1154000 + 1000
y_ <- 2364000 + 2000
size_ <- 4000
checking_square <- geom_polygon(data = data.frame(x = c(x_, x_ + size_, x_ + size_, x_),
    y = c(y_, y_, y_ + size_, y_ + size_), response = "RdNBR"), aes_string(x = "x", y = "y"),
    inherit.aes = FALSE, fill = "grey50", lwd = 1, col = "black")

lets <- data.frame(
  predictor = "RdNBR",
  response = c("Basal area killed by fire", "Charred surface cover"),
  panel = 
    paste0("(", letters[0 + seq_len(2)], ")"),
  x = max(xx$x) - diff(range(xx$x)) * 0.05,
  y = max(xx$y) - diff(range(xx$y)) * 0.02,
  stringsAsFactors = FALSE)

lets$panel[lets$panel == "(b)"] <- ""

lets$response <- "RdNBR"
lets$predictor <- ""

predictor_plot <- 
  xx %>% 
  mutate(response = gsub("Firemort.BA.p", "Basal area killed by fire", response)) %>% 
  mutate(response = gsub("CHARCOV", "Charred surface cover", response)) %>%
  mutate(predictor = gsub("RdNBR_BL", "RdNBR", predictor)) %>%
  # mutate(y = ifelse(response == "Basal area killed by fire", y, NA)) %>%
  filter(response == "Basal area killed by fire") %>% 
  mutate(response = "RdNBR") %>%
  mutate(predictor = "") %>%
  ggplot(aes(x, y, fill = RdNBR_BL)) + 
  geom_raster() +
  facet_grid(predictor~as.character(response)) +
  # viridis::scale_fill_viridis(option = "D") +
  scale_fill_distiller(palette = "Greys") +
  coord_fixed() +
  ggsidekick::theme_sleek() +
  xlab("") + ylab("") +
  labs(fill = "RdNBR") +
  geom_text(data = lets, aes(label = panel, x = x, y = y), 
    inherit.aes = FALSE, col = "grey30") +
    # theme(aspect.ratio = 1) +
   # theme(
  # strip.background = element_blank(),
  # strip.text.x = element_blank()) +
  theme(
    legend.justification = c(1, 0), 
    legend.position = c(0.38, 0.01),
    legend.text = element_text(size = 6), 
    legend.title = element_text(size = 8)) +
  guides(fill = guide_colourbar(barwidth = 0.8, barheight = 3.0)) +
  theme(axis.text = element_blank(), axis.ticks = element_blank()) +
  xlab("") + ylab("") #+ checking_square 
# predictor_plot
```

```{r, fig.asp=1, fig.cap="The 5%, 50%, and 95% quantiles of the posterior."}

lets2 <- data.frame(
  variable = rep(c(
    "Predicted 5% quantile", 
    "Predicted median",
    "Predicted 95% quantile"), each = 2),
  response = rep(c("Basal area killed by fire", "Charred surface cover"), 3),
  panel = 
    paste0("(", letters[1 + seq_len(6)], ")"),
  x = unique(lets$x),
  y = unique(lets$y),
  stringsAsFactors = FALSE)

fig <- select(xx, x, y, response, q0.05, q0.50, q0.95) %>%
  rename(`Predicted 5% quantile` = q0.05, `Predicted 95% quantile` = q0.95, `Predicted median` = q0.50) %>% 
  mutate(response = gsub("Firemort.BA.p", "Basal area killed by fire", response)) %>% 
  mutate(response = gsub("CHARCOV", "Charred surface cover", response)) %>%
  reshape2::melt(id.vars = c("x", "y", "response")) %>%
  ggplot(aes(x, y, fill = value)) + geom_raster() +
  facet_grid(factor(variable, levels = c(
    "Predicted 5% quantile",
    "Predicted median",
    "Predicted 95% quantile"
  ))~response) +
  coord_fixed() +
  # scale_fill_distiller(palette = "RdBu", limits = c(0, 1)) +
  # scale_fill_distiller(palette = "RdGy", limits = c(0, 1), direction = -1) +
  viridis::scale_fill_viridis(option = "D", limits = c(0, 1), direction = 1) +
  # rcartocolor::scale_fill_carto_c(palette = "TealRose", limits = c(0, 1)) +
    # rcartocolor::scale_fill_carto_c(palette = "Geyser", limits = c(0, 1)) +

  # coord_equal() +
  ggsidekick::theme_sleek() +
  labs(fill = "Proportion") +
    # theme(aspect.ratio = 1) +
  theme(legend.justification = c(1, 0), 
    legend.position = c(0.23, 0.68),
    legend.text = element_text(size = 6), 
    legend.title = element_text(size = 8)) +
  guides(fill = guide_colourbar(barwidth = 0.8, barheight = 3.0)) +
  theme(axis.text = element_blank(), axis.ticks = element_blank()) +
  xlab("") + ylab("") +
  geom_text(data = lets2, aes(label = panel, x = x, y = y), 
    inherit.aes = FALSE, col = "grey30") #+ checking_square
  
# fig

g <- cowplot::plot_grid(predictor_plot, fig, ncol = 1, rel_heights = c(1.03, 2.5),
  align = "v", axis = "l")

ggsave("map-cred2.png", width = 3.9, height = 7.9, dpi = 220)

# library(colorblindr)
# pdf("cb.pdf", width = 10, height = 10)
# cvd_grid(fig)
# dev.off()
```

```{r, fig.asp=1.2, fig.cap="A breakdown of the components of the final model."}
comp_levels <- c("Probability not 0", "Proportion if not 0 or 1", 
  "Probability 1 if y not 0", "Combined proportion estimate")

lets2 <- data.frame(
  variable = rep(comp_levels, each = 2),
  response = rep(c("Basal area killed by fire", "Charred surface cover"), 4),
  panel = 
    paste0("(", letters[0 + seq_len(8)], ")"),
  x = unique(lets$x),
  y = unique(lets$y),
  stringsAsFactors = FALSE)
lets2$variable <- factor(lets2$variable, 
        levels = comp_levels)

select(xx, x, y, response, pp_est, p0_est, p1_est, q0.50) %>%
  mutate(`Probability not 0` = 1 - p0_est) %>% 
  select(-p0_est) %>%
  rename(`Proportion if not 0 or 1` = pp_est) %>% 
  rename(`Probability 1 if y not 0` = p1_est) %>% 
  rename(`Combined proportion estimate` = q0.50) %>% 
  reshape2::melt(id.vars = c("x", "y", "response")) %>%
  mutate(variable = 
      factor(variable, 
        levels = comp_levels)) %>% 
   mutate(response = gsub("Firemort.BA.p", "Basal area killed by fire", response)) %>% 
  mutate(response = gsub("CHARCOV", "Charred surface cover", response)) %>%
  ggplot(aes(x, y, fill = value)) + geom_raster() +
  facet_grid(variable~response) +
  # scale_fill_distiller(palette = "RdBu", limits = c(0, 1)) +
  viridis::scale_fill_viridis(option = "D", limits = c(0, 1), direction = 1) +
  # rcartocolor::scale_fill_carto_c(palette = "TealRose", limits = c(0, 1)) +
  # rcartocolor::scale_fill_carto_c(palette = "Geyser", limits = c(0, 1)) +
  coord_equal() +
  ggsidekick::theme_sleek() +
  theme(axis.text = element_blank(), axis.ticks = element_blank()) +
  xlab("") + ylab("") +
  labs(fill = "") +
  theme(legend.justification = c(1, 0), 
    legend.position = c(0.19, 0.762),
    legend.text = element_text(size = 6), 
    legend.title = element_text(size = 8)) +
  guides(fill = guide_colourbar(barwidth = 0.8, barheight = 3.1)) +
  geom_text(data = lets2, aes(label = panel, x = x, y = y), 
    inherit.aes = FALSE, col = "grey30")
ggsave("map-components.png", width = 4, height = 7.5, dpi = 200)
```
